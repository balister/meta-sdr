From 1ac251f9452c0f670c567d782e7ccc89355ecc40 Mon Sep 17 00:00:00 2001
From: Philip Balister <philip@balister.org>
Date: Mon, 11 Jan 2021 16:17:48 -0500
Subject: [PATCH] Modify ctest so we can package the testfiles and install on
 the target.

This lets us run the volk tests on the embedded target easily. Major changes
are not including full paths to files, since these were based on the build
system paths and not setting paths to find libraries in the build directory.

Upstream-Status: Inappropriate [Upstream may have a conflicting test
setup]

Signed-off-by: Philip Balister <philip@balister.org>
---
 cmake/Modules/VolkAddTest.cmake | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/cmake/Modules/VolkAddTest.cmake b/cmake/Modules/VolkAddTest.cmake
index f4aef6e..817b52b 100644
--- a/cmake/Modules/VolkAddTest.cmake
+++ b/cmake/Modules/VolkAddTest.cmake
@@ -135,6 +135,7 @@ function(VOLK_ADD_TEST test_name executable_name)
         #generate a shell script file that sets the environment and runs the test
         set(sh_file ${CMAKE_CURRENT_BINARY_DIR}/${test_name}_test.sh)
         file(WRITE ${sh_file} "#!${SHELL}\n")
+	if (NOT CMAKE_CROSSCOMPILING)
         if(SHELL_SUPPORTS_IFS)
             file(APPEND ${sh_file} "export IFS=:\n")
         else()
@@ -146,6 +147,7 @@ function(VOLK_ADD_TEST test_name executable_name)
         foreach(environ ${environs})
             file(APPEND ${sh_file} "export ${environ}\n")
         endforeach(environ)
+        endif(CMAKE_CROSSCOMPILING)
 
         set(VOLK_TEST_ARGS "${test_name}")
 
@@ -162,7 +164,11 @@ function(VOLK_ADD_TEST test_name executable_name)
         #add the shell file as the test to execute;
         #use the form that allows for $<FOO:BAR> substitutions,
         #then combine the script arguments inside the script.
+	if (NOT CMAKE_CROSSCOMPILING)
         add_test(NAME qa_${test_name} COMMAND ${SHELL} ${sh_file} ${TARGET_DIR_LIST})
+	else()
+        add_test(NAME qa_${test_name} COMMAND ${SHELL} ${test_name}_test.sh ${TARGET_DIR_LIST})
+        endif (CMAKE_CROSSCOMPILING)
 
     endif(UNIX)
 
-- 
2.52.0

