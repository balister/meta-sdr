From 83efa4fd20cac7a4984e302042cca3078f82b4e4 Mon Sep 17 00:00:00 2001
From: Philip Balister <philip@balister.org>
Date: Thu, 6 Jun 2013 16:18:06 -0400
Subject: [PATCH] Modify Makefile for cross compile.

Signed-off-by: Philip Balister <philip@balister.org>
---
 Makefile                    |  8 ++++----
 config/Make.common.rules    | 12 ++++++------
 cpp/Makefile                |  8 ++------
 cpp/config/Make.rules       | 14 +++++++-------
 cpp/config/Make.rules.Linux | 30 ++++--------------------------
 cpp/src/Makefile            | 18 +-----------------
 6 files changed, 24 insertions(+), 66 deletions(-)

diff --git a/Makefile b/Makefile
index ba3d716..a575f49 100644
--- a/Makefile
+++ b/Makefile
@@ -7,10 +7,10 @@
 #
 # **********************************************************************
 
-SUBDIRS			= cpp java cs py rb php
-CLEAN_SUBDIRS		= java cs py rb php cpp
-DEPEND_SUBDIRS		= cpp cs py rb php
-INSTALL_SUBDIRS		= cpp java cs py rb php
+SUBDIRS			= cpp
+CLEAN_SUBDIRS		= cpp
+DEPEND_SUBDIRS		= cpp
+INSTALL_SUBDIRS		= cpp
 
 all::
 	@for subdir in $(SUBDIRS); \
diff --git a/config/Make.common.rules b/config/Make.common.rules
index 36af975..adc9747 100644
--- a/config/Make.common.rules
+++ b/config/Make.common.rules
@@ -79,13 +79,13 @@ ifneq ($(findstring MINGW,$(UNAME)),)
     UNAME	:= MINGW
 endif
 
-ifeq ($(LP64),yes)
-	libsubdir		:= lib$(lp64suffix)
-    binsubdir		:= bin$(lp64binsuffix)
-else
+#ifeq ($(LP64),yes)
+#	libsubdir		:= lib$(lp64suffix)
+#    binsubdir		:= bin$(lp64binsuffix)
+#else
 	libsubdir		:= lib
 	binsubdir		:= bin
-endif
+#endif
 
 #
 # The following variables might also be defined:
@@ -394,4 +394,4 @@ install-common::
 	@if test ! -f $(prefix)/LICENSE$(TEXT_EXTENSION) ; \
 	then \
 	    $(call installdata,$(top_srcdir)/../LICENSE$(TEXT_EXTENSION),$(prefix)) ; \
-	fi
\ No newline at end of file
+	fi
diff --git a/cpp/Makefile b/cpp/Makefile
index e5df3fc..bf74f91 100644
--- a/cpp/Makefile
+++ b/cpp/Makefile
@@ -11,13 +11,9 @@ top_srcdir	= .
 
 include $(top_srcdir)/config/Make.rules
 
-SUBDIRS		= config src include test
+SUBDIRS		= src
 
-ifeq ($(shell uname | grep MINGW),)
-SUBDIRS		:= $(SUBDIRS) demo
-endif
-
-INSTALL_SUBDIRS	= $(install_bindir) $(install_libdir) $(install_includedir) $(install_configdir)
+INSTALL_SUBDIRS	= $(install_bindir) $(install_libdir)
 
 install:: install-common
 	@for subdir in $(INSTALL_SUBDIRS); \
diff --git a/cpp/config/Make.rules b/cpp/config/Make.rules
index c743143..53a82c1 100644
--- a/cpp/config/Make.rules
+++ b/cpp/config/Make.rules
@@ -262,13 +262,13 @@ ICECPPFLAGS		= -I$(slicedir)
 SLICE2CPPFLAGS		= $(ICECPPFLAGS)
 
 ifeq ($(ice_dir), /usr) 
-    LDFLAGS		= $(LDPLATFORMFLAGS) $(CXXFLAGS)
+    LDFLAGS		+= $(LDPLATFORMFLAGS) $(CXXFLAGS)
 else
     CPPFLAGS	+= -I$(includedir)
     ifdef ice_src_dist
-	LDFLAGS	= $(LDPLATFORMFLAGS) $(CXXFLAGS) -L$(libdir)
+	LDFLAGS	+= $(LDPLATFORMFLAGS) $(CXXFLAGS) -L$(libdir)
     else
-	LDFLAGS	= $(LDPLATFORMFLAGS) $(CXXFLAGS) -L$(ice_dir)/$(libsubdir)$(cpp11suffix)
+	LDFLAGS	+= $(LDPLATFORMFLAGS) $(CXXFLAGS) -L$(ice_dir)/$(libsubdir)$(cpp11suffix)
     endif
 endif
 
@@ -290,15 +290,15 @@ endif
 
 ifdef ice_src_dist
     SLICEPARSERLIB	= $(libdir)/$(call mklibfilename,Slice,$(VERSION))
-    SLICE2CPP		= $(bindir)/slice2cpp
-    SLICE2FREEZE	= $(bindir)/slice2freeze
+    SLICE2CPP		= slice2cpp
+    SLICE2FREEZE	= slice2freeze
     ifeq ($(RPATH_DIR),)
       RPATH_DIR = @loader_path/$(libdir)
     endif
 else
     SLICEPARSERLIB	= $(ice_dir)/$(libsubdir)$(cpp11suffix)/$(call mklibfilename,Slice,$(VERSION))
-    SLICE2CPP		= $(ice_dir)/$(binsubdir)$(cpp11suffix)/slice2cpp
-    SLICE2FREEZE	= $(ice_dir)/$(binsubdir)$(cpp11suffix)/slice2freeze
+    SLICE2CPP		= slice2cpp
+    SLICE2FREEZE	= slice2freeze
     ifeq ($(RPATH_DIR),)
       RPATH_DIR = $(ice_dir)/$(libsubdir)$(cpp11suffix)
     endif
diff --git a/cpp/config/Make.rules.Linux b/cpp/config/Make.rules.Linux
index 51dab34..b64a690 100644
--- a/cpp/config/Make.rules.Linux
+++ b/cpp/config/Make.rules.Linux
@@ -20,19 +20,6 @@ ifneq ($(shell grep 'release 4' /etc/redhat-release 2>/dev/null),)
    NPTL_FLAGS		= -I/usr/include/nptl
 endif
 
-#
-# Default compiler is c++ (aka g++).
-#
-ifeq ($(CXX),)
-   CXX			= g++
-endif
-
-ifeq ($(CXX),c++)
-   CXX			= g++
-endif
-
-ifeq ($(CXX),g++)
-
     ifneq ($(SUSE_i586),)
         CXXARCHFLAGS	+= -march=i586
     endif
@@ -71,15 +58,7 @@ ifeq ($(CXX),g++)
       CXXARCHFLAGS	+= -mtune=v8 -pipe -Wno-deprecated -DICE_USE_MUTEX_SHARED
    endif
 
-   ifeq ($(MACHINE),x86_64)
-      ifeq ($(LP64),yes)
-         CXXARCHFLAGS	+= -m64
-      else
-         CXXARCHFLAGS	+= -m32
-      endif
-   endif
-
-   CXXFLAGS		= $(CXXARCHFLAGS) -Wall -Werror -D_REENTRANT
+   CXXFLAGS		+= $(CXXARCHFLAGS) -Wall -Werror -D_REENTRANT
 
    ifneq ($(GENPIC),no)
       CXXFLAGS		+= -fPIC
@@ -94,11 +73,11 @@ ifeq ($(CXX),g++)
    #
    # C++ run-time libraries, necessary for linking some shared libraries.
    #
-   CXXLIBS		=
+   CXXLIBS		+=
 
    mkshlib		= $(CXX) -shared $(LDFLAGS) -o $(1) -Wl,-h,$(2) $(3) $(4) -lpthread -lrt
 
-   mklib		= ar cr $(1) $(2)
+   mklib		= $(AR) cr $(1) $(2)
 
    rpathlink            = -Wl,-rpath-link,$(1) 
 
@@ -110,7 +89,6 @@ ifeq ($(CXX),g++)
 
    LDPLATFORMFLAGS	+= -rdynamic
 
-endif
 
 ifeq ($(CXX),icpc)
    $(warning ===================================================================) 
@@ -165,4 +143,4 @@ ifneq ($(QT_HOME),)
    QT_FLAGS             = -I$(QT_HOME)/include
    QT_LIBS              = -L$(QT_HOME)/$(libsubdir) -lQtCore -lQtSql
    QT_RPATH_LINK        = $(call rpathlink,$(QT_HOME)/$(libsubdir))
-endif
\ No newline at end of file
+endif
diff --git a/cpp/src/Makefile b/cpp/src/Makefile
index 93e9bb2..c1e8f0c 100644
--- a/cpp/src/Makefile
+++ b/cpp/src/Makefile
@@ -29,23 +29,7 @@ else
 			  slice2php \
 			  slice2py \
 			  slice2rb \
-			  slice2html \
-			  Ice \
-			  IceXML \
-			  IceSSL \
-			  Freeze \
-			  FreezeScript \
-			  IceBox \
-			  Glacier2Lib \
-			  Glacier2 \
-			  IceDB \
-			  IcePatch2Lib \
-			  IcePatch2 \
-			  IceStormLib \
-			  IceGridLib \
-			  IceStorm \
-			  IceGrid \
-			  ca
+			  slice2html
 endif
 
 .PHONY: $(EVERYTHING) $(SUBDIRS)
-- 
1.7.11.7

